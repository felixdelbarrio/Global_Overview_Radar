name: deploy_cloudrun_frontend

on:
  workflow_run:
    workflows: ["CI - Frontend"]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: deploy-cloudrun-frontend-${{ github.event.workflow_run.head_sha || github.sha }}
  cancel-in-progress: true

jobs:
  deploy:
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref_name == 'master') ||
      (
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'push' &&
        github.event.workflow_run.head_branch == 'master'
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      id-token: write
    env:
      GCP_PROJECT: global-overview-radar
      GCP_REGION: europe-southwest1

      BACKEND_SERVICE: gor-backend
      FRONTEND_SERVICE: gor-frontend

      # ✅ Runtime service account (Cloud Run execution identity) - YA TENÉIS: gor-frontend-sa
      FRONTEND_RUNTIME_SA: gor-frontend-sa@global-overview-radar.iam.gserviceaccount.com

      FRONTEND_MAX_INSTANCES: "1"
      FRONTEND_CONCURRENCY: "2"
      FRONTEND_MEMORY: 768Mi
      FRONTEND_CPU: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Create GitHub Deployment (Production - Frontend)
        id: create_deploy
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = (context.payload.workflow_run && context.payload.workflow_run.head_sha) || context.sha;

            const res = await github.rest.repos.createDeployment({
              owner,
              repo,
              ref: sha,
              environment: "Production",
              auto_merge: false,
              required_contexts: [],
              description: "Cloud Run frontend deployment",
              transient_environment: false,
              production_environment: true,
            });

            core.setOutput("deployment_id", String(res.data.id));

      - name: Mark deployment as in_progress
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const deployment_id = Number(`${{ steps.create_deploy.outputs.deployment_id }}`);

            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id,
              state: "in_progress",
              description: "Deploying frontend to Cloud Run",
            });

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v3

      - name: Resolve login bypass toggle (GitHub Actions secret)
        id: login_toggle
        env:
          RAW_LOGIN_REQUESTED: ${{ secrets.GOOGLE_CLOUD_LOGIN_REQUESTED }}
        run: |
          set -euo pipefail
          value="$(echo "${RAW_LOGIN_REQUESTED:-false}" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')"
          if [ "$value" != "true" ]; then
            value="false"
          fi
          echo "value=${value}" >> "$GITHUB_OUTPUT"
          echo "GOOGLE_CLOUD_LOGIN_REQUESTED=${value}"

      - name: Resolve backend URL
        id: backend_url
        run: |
          set -euo pipefail
          BACKEND_URL="$(gcloud run services describe "$BACKEND_SERVICE" \
            --project "$GCP_PROJECT" \
            --region "$GCP_REGION" \
            --format 'value(status.url)')"

          if [ -z "${BACKEND_URL:-}" ]; then
            echo "Failed to resolve backend URL. Is backend deployed?"
            exit 1
          fi

          echo "url=$BACKEND_URL" >> "$GITHUB_OUTPUT"
          echo "Resolved backend URL: $BACKEND_URL"

      - name: Deploy frontend (Cloud Run) - proxy /api -> backend
        id: deploy_frontend
        env:
          AUTH_GOOGLE_CLIENT_ID: ${{ secrets.AUTH_GOOGLE_CLIENT_ID }}
        run: |
          set -euo pipefail

          LOGIN_REQUESTED="${{ steps.login_toggle.outputs.value }}"

          # Si login requerido, validamos client id; si bypass, no lo inyectamos.
          if [ "${LOGIN_REQUESTED}" = "true" ]; then
            if [ -z "${AUTH_GOOGLE_CLIENT_ID:-}" ]; then
              echo "Missing AUTH_GOOGLE_CLIENT_ID secret."
              exit 1
            fi
            if ! echo "${AUTH_GOOGLE_CLIENT_ID}" | grep -q '\.apps\.googleusercontent\.com$'; then
              echo "ERROR: AUTH_GOOGLE_CLIENT_ID must end in .apps.googleusercontent.com (got: ${AUTH_GOOGLE_CLIENT_ID})"
              exit 1
            fi
          fi

          BACKEND_URL="${{ steps.backend_url.outputs.url }}"

          # Vars comunes (sin AUTH_GOOGLE_CLIENT_ID si bypass)
          ENV_VARS_COMMON="USE_SERVER_PROXY=true,API_PROXY_TARGET=${BACKEND_URL},NEXT_PUBLIC_API_BASE_URL=/api,NEXT_PUBLIC_GOOGLE_CLOUD_LOGIN_REQUESTED=${LOGIN_REQUESTED},NEXT_PUBLIC_DISABLE_ADVANCED_SETTINGS=true"

          if [ "${LOGIN_REQUESTED}" = "true" ]; then
            ENV_VARS_COMMON="${ENV_VARS_COMMON},AUTH_GOOGLE_CLIENT_ID=${AUTH_GOOGLE_CLIENT_ID}"
          fi

          gcloud run deploy "$FRONTEND_SERVICE" \
            --project "$GCP_PROJECT" \
            --region "$GCP_REGION" \
            --source frontend/brr-frontend \
            --service-account "$FRONTEND_RUNTIME_SA" \
            --allow-unauthenticated \
            --min-instances 0 \
            --max-instances "$FRONTEND_MAX_INSTANCES" \
            --concurrency "$FRONTEND_CONCURRENCY" \
            --cpu "$FRONTEND_CPU" \
            --memory "$FRONTEND_MEMORY" \
            --cpu-throttling \
            --set-env-vars "${ENV_VARS_COMMON}" \
            --set-build-env-vars "${ENV_VARS_COMMON}"

          gcloud run services update-traffic "$FRONTEND_SERVICE" \
            --project "$GCP_PROJECT" \
            --region "$GCP_REGION" \
            --to-latest

          FRONTEND_URL="$(gcloud run services describe "$FRONTEND_SERVICE" \
            --project "$GCP_PROJECT" \
            --region "$GCP_REGION" \
            --format 'value(status.url)')"

          if [ -z "$FRONTEND_URL" ]; then
            echo "Failed to resolve frontend URL."
            exit 1
          fi

          STATUS="$(curl -s -o /dev/null -w "%{http_code}" "${FRONTEND_URL}")"
          if [ "$STATUS" -ne 200 ]; then
            echo "Frontend health check failed: ${FRONTEND_URL} returned status ${STATUS}."
            exit 1
          fi

          echo "url=$FRONTEND_URL" >> "$GITHUB_OUTPUT"
          echo "Deployment successful. Frontend available at: ${FRONTEND_URL}"

      - name: Ensure frontend is public (Cloud Run)
        run: |
          set -euo pipefail
          gcloud run services add-iam-policy-binding "$FRONTEND_SERVICE" \
            --project "$GCP_PROJECT" \
            --region "$GCP_REGION" \
            --member="allUsers" \
            --role="roles/run.invoker"

      - name: Mark deployment as success
        if: success()
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const deployment_id = Number(`${{ steps.create_deploy.outputs.deployment_id }}`);
            const frontendUrl = `${{ steps.deploy_frontend.outputs.url }}`;

            const payload = {
              owner,
              repo,
              deployment_id,
              state: "success",
              description: "Frontend deployed to Cloud Run",
            };
            if (frontendUrl) payload.environment_url = frontendUrl;

            await github.rest.repos.createDeploymentStatus(payload);

      - name: Mark deployment as failure
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const deployment_id = Number(`${{ steps.create_deploy.outputs.deployment_id }}`);

            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id,
              state: "failure",
              description: "Frontend deploy failed",
            });