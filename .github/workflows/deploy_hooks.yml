name: deploy_hooks

on:
  workflow_run:
    workflows: ["CI", "typecheck", "format"]
    types: [completed]

concurrency:
  group: deploy-hooks-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  gate:
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      (github.event.workflow_run.head_branch == 'develop' || github.event.workflow_run.head_branch == 'master')
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    outputs:
      ok: ${{ steps.check.outputs.ok }}
    steps:
      - name: Check all workflows succeeded
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = ["typecheck.yml", "backend.yml", "frontend.yml", "format.yml"];
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headSha = context.payload.workflow_run.head_sha;
            let allOk = true;
            for (const wf of workflows) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: wf,
                head_sha: headSha,
                per_page: 1,
              });
              const run = runs.data.workflow_runs[0];
              if (!run || run.status !== "completed" || run.conclusion !== "success") {
                allOk = false;
                core.info(
                  `Workflow ${wf} not successful for ${headSha}: ${
                    run ? `${run.status}/${run.conclusion}` : "missing"
                  }`
                );
              }
            }
            core.setOutput("ok", allOk ? "true" : "false");

  deploy:
    needs: gate
    if: needs.gate.outputs.ok == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Trigger Render deploy hook
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          set -euo pipefail
          if [ -z "${RENDER_DEPLOY_HOOK_URL}" ]; then
            echo "Render hook not configured (missing RENDER_DEPLOY_HOOK_URL secret)."
            exit 0
          fi
          url="${RENDER_DEPLOY_HOOK_URL}"
          code="$(curl -sS -o /tmp/render_hook.out -w "%{http_code}" -X POST -L "$url" || true)"
          if [ "${code}" = "405" ]; then
            code="$(curl -sS -o /tmp/render_hook.out -w "%{http_code}" -L "$url")"
          fi
          echo "Render deploy hook HTTP ${code}"
          cat /tmp/render_hook.out || true
          test "${code}" -ge 200 -a "${code}" -lt 400

      - name: Trigger Vercel deploy hook
        env:
          VERCEL_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
        run: |
          set -euo pipefail
          if [ -z "${VERCEL_DEPLOY_HOOK_URL}" ]; then
            echo "Vercel hook not configured (missing VERCEL_DEPLOY_HOOK_URL secret)."
            exit 0
          fi
          url="${VERCEL_DEPLOY_HOOK_URL}"
          code="$(curl -sS -o /tmp/vercel_hook.out -w "%{http_code}" -X POST -L "$url" || true)"
          if [ "${code}" = "405" ]; then
            code="$(curl -sS -o /tmp/vercel_hook.out -w "%{http_code}" -L "$url")"
          fi
          echo "Vercel deploy hook HTTP ${code}"
          cat /tmp/vercel_hook.out || true
          test "${code}" -ge 200 -a "${code}" -lt 400

      - name: Hooks status
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
          VERCEL_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "${RENDER_DEPLOY_HOOK_URL}" ]; then
            echo "Render hook not configured (missing RENDER_DEPLOY_HOOK_URL secret)."
          else
            echo "Render hook configured."
          fi
          if [ -z "${VERCEL_DEPLOY_HOOK_URL}" ]; then
            echo "Vercel hook not configured (missing VERCEL_DEPLOY_HOOK_URL secret)."
          else
            echo "Vercel hook configured."
          fi
