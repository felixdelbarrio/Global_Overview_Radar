name: deploy_cloudrun_backend

on:
  workflow_run:
    workflows: ["CI - Backend"]
    types: [completed]

concurrency:
  group: deploy-cloudrun-backend-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  deploy:
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'master'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      id-token: write
    env:
      GCP_PROJECT: global-overview-radar
      GCP_REGION: europe-southwest1
      BACKEND_SERVICE: gor-backend
      BACKEND_PYTHON_RUNTIME: "3.13"

      BACKEND_MAX_INSTANCES: "1"
      BACKEND_CONCURRENCY: "2"
      BACKEND_MEMORY: 768Mi
      BACKEND_CPU: "1"

      FRONTEND_SERVICE: gor-frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Create GitHub Deployment (Production - Backend)
        id: create_deploy
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.payload.workflow_run.head_sha;

            const res = await github.rest.repos.createDeployment({
              owner,
              repo,
              ref: sha,
              environment: "Production",
              auto_merge: false,
              required_contexts: [],
              description: "Cloud Run backend deployment",
              transient_environment: false,
              production_environment: true,
            });

            core.setOutput("deployment_id", String(res.data.id));

      - name: Mark deployment as in_progress
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const deployment_id = Number(`${{ steps.create_deploy.outputs.deployment_id }}`);

            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id,
              state: "in_progress",
              description: "Deploying backend to Cloud Run",
            });

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Resolve login bypass toggle (GitHub Actions secret)
        id: login_toggle
        env:
          RAW_LOGIN_REQUESTED: ${{ secrets.GOOGLE_CLOUD_LOGIN_REQUESTED }}
        run: |
          set -euo pipefail
          value="$(echo "${RAW_LOGIN_REQUESTED:-false}" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')"
          if [ "$value" != "true" ]; then
            value="false"
          fi
          echo "value=${value}" >> "$GITHUB_OUTPUT"
          echo "GOOGLE_CLOUD_LOGIN_REQUESTED=${value}"

      - name: Prepare backend env file
        env:
          AUTH_GOOGLE_CLIENT_ID: ${{ secrets.AUTH_GOOGLE_CLIENT_ID }}
          AUTH_ALLOWED_EMAILS: ${{ secrets.AUTH_ALLOWED_EMAILS }}
        run: |
          set -euo pipefail

          awk -F= '$0 !~ /^[[:space:]]*#/ && $0 ~ /=/ {print $0}' backend/reputation/.env.reputation.example > backend/reputation/cloudrun.env

          LOGIN_REQUESTED="${{ steps.login_toggle.outputs.value }}"
          BYPASS_ALLOW_MUTATIONS="false"
          BYPASS_MUTATION_KEY=""
          if [ "${LOGIN_REQUESTED}" != "true" ]; then
            BYPASS_MUTATION_KEY="$(gcloud secrets versions access latest \
              --secret AUTH_BYPASS_MUTATION_KEY \
              --project "$GCP_PROJECT" 2>/dev/null || true)"
            BYPASS_MUTATION_KEY="$(echo "$BYPASS_MUTATION_KEY" | tr -d '\r\n')"
            if [ -n "${BYPASS_MUTATION_KEY}" ] && [ "${#BYPASS_MUTATION_KEY}" -lt 32 ]; then
              echo "AUTH_BYPASS_MUTATION_KEY must be at least 32 characters."
              exit 1
            fi
            if [ -n "${BYPASS_MUTATION_KEY}" ]; then
              BYPASS_ALLOW_MUTATIONS="true"
            else
              echo "::warning::AUTH_BYPASS_MUTATION_KEY missing while GOOGLE_CLOUD_LOGIN_REQUESTED=false. Deploying backend in bypass read-only mode (mutations disabled)."
            fi
          fi

          if [ "${LOGIN_REQUESTED}" = "true" ] && [ -z "${AUTH_GOOGLE_CLIENT_ID:-}" ]; then
            echo "Missing AUTH_GOOGLE_CLIENT_ID secret."
            exit 1
          fi

          # Allow the frontend Cloud Run URL pattern:
          CORS_REGEX="^https://${FRONTEND_SERVICE}-.+\\.a\\.run\\.app$"

          cat >> backend/reputation/cloudrun.env <<EOF
          AUTH_ENABLED=true
          AUTH_GOOGLE_CLIENT_ID=${AUTH_GOOGLE_CLIENT_ID}
          AUTH_ALLOWED_EMAILS=${AUTH_ALLOWED_EMAILS}
          GOOGLE_CLOUD_LOGIN_REQUESTED=${LOGIN_REQUESTED}
          AUTH_BYPASS_ALLOW_MUTATIONS=${BYPASS_ALLOW_MUTATIONS}
          AUTH_BYPASS_MUTATION_KEY=${BYPASS_MUTATION_KEY}
          CORS_ALLOWED_ORIGIN_REGEX=${CORS_REGEX}
          EOF

      - name: Deploy backend (Cloud Run)
        run: |
          set -euo pipefail
          BUILD_VARS="GOOGLE_RUNTIME_VERSION=${BACKEND_PYTHON_RUNTIME},GOOGLE_ENTRYPOINT=python -m uvicorn reputation.api.main:app --host 0.0.0.0 --port 8080"

          # Buildpacks: source must include backend pyproject for dependency install.
          # Entry point binds explicitly to 8080 (Cloud Run default container port).
          gcloud run deploy "$BACKEND_SERVICE" \
            --project "$GCP_PROJECT" \
            --region "$GCP_REGION" \
            --source backend \
            --no-allow-unauthenticated \
            --min-instances 0 \
            --max-instances "$BACKEND_MAX_INSTANCES" \
            --concurrency "$BACKEND_CONCURRENCY" \
            --cpu "$BACKEND_CPU" \
            --memory "$BACKEND_MEMORY" \
            --cpu-throttling \
            --timeout 300 \
            --set-build-env-vars "${BUILD_VARS}" \
            --env-vars-file backend/reputation/cloudrun.env

      - name: Show latest failed Cloud Build details
        if: failure()
        run: |
          set -euo pipefail
          SERVICE_TAG="service_${BACKEND_SERVICE}"
          BUILD_ID="$(gcloud builds list \
            --project "$GCP_PROJECT" \
            --region "$GCP_REGION" \
            --filter "tags:${SERVICE_TAG} AND status=FAILURE" \
            --sort-by '~createTime' \
            --limit 1 \
            --format 'value(id)')"

          if [ -z "${BUILD_ID:-}" ]; then
            echo "No failed Cloud Build found for ${BACKEND_SERVICE}."
            exit 0
          fi

          echo "Latest failed Cloud Build ID: ${BUILD_ID}"
          gcloud builds describe "$BUILD_ID" \
            --project "$GCP_PROJECT" \
            --region "$GCP_REGION" \
            --format 'yaml(id,status,createTime,finishTime,statusDetail,logUrl,steps.id,steps.status,steps.exitCode)'
          if ! gcloud builds log "$BUILD_ID" \
            --project "$GCP_PROJECT" \
            --region "$GCP_REGION"; then
            echo "::warning::Unable to stream Cloud Build logs for ${BUILD_ID}. Check the logUrl above and ensure the CI service account has log-view permissions."
          fi

      - name: Show backend URL
        id: backend_url
        run: |
          set -euo pipefail
          BACKEND_URL="$(gcloud run services describe "$BACKEND_SERVICE" \
            --project "$GCP_PROJECT" \
            --region "$GCP_REGION" \
            --format 'value(status.url)')"
          echo "url=$BACKEND_URL" >> "$GITHUB_OUTPUT"
          echo "$BACKEND_URL"

      - name: Mark deployment as success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const deployment_id = Number(`${{ steps.create_deploy.outputs.deployment_id }}`);
            const backendUrl = `${{ steps.backend_url.outputs.url }}`;

            const payload = {
              owner,
              repo,
              deployment_id,
              state: "success",
              description: "Backend deployed to Cloud Run",
            };
            if (backendUrl) payload.environment_url = backendUrl;

            await github.rest.repos.createDeploymentStatus(payload);

      - name: Mark deployment as failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const deployment_id = Number(`${{ steps.create_deploy.outputs.deployment_id }}`);

            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id,
              state: "failure",
              description: "Backend deploy failed",
            });
