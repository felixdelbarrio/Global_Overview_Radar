name: deploy_cloudrun_backend

on:
  workflow_run:
    workflows: ["CI - Backend"]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: deploy-cloudrun-backend-${{ github.event.workflow_run.head_sha || github.sha }}
  cancel-in-progress: true

jobs:
  deploy:
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref_name == 'master') ||
      (
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'push' &&
        github.event.workflow_run.head_branch == 'master'
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      id-token: write

    env:
      GCP_PROJECT: global-overview-radar
      GCP_REGION: europe-southwest1

      BACKEND_SERVICE: gor-backend

      # Artifact Registry (como en Makefile)
      AR_REPO: cloud-run-source-deploy
      AR_IMAGE_BACK_NAME: gor-backend

      # Runtime identity (Cloud Run execution SA)
      BACKEND_RUNTIME_SA: gor-backend-sa@global-overview-radar.iam.gserviceaccount.com

      BACKEND_MAX_INSTANCES: "1"
      BACKEND_CONCURRENCY: "2"
      BACKEND_MEMORY: 768Mi
      BACKEND_CPU: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v3

      - name: Resolve login bypass toggle (GitHub Actions secret)
        id: login_toggle
        env:
          RAW_LOGIN_REQUESTED: ${{ secrets.GOOGLE_CLOUD_LOGIN_REQUESTED }}
        run: |
          set -euo pipefail
          value="$(echo "${RAW_LOGIN_REQUESTED:-false}" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')"
          if [ "$value" != "true" ]; then value="false"; fi
          echo "value=${value}" >> "$GITHUB_OUTPUT"
          echo "GOOGLE_CLOUD_LOGIN_REQUESTED=${value}"

      - name: Prepare backend env file (cloudrun.env)
        env:
          AUTH_GOOGLE_CLIENT_ID: ${{ secrets.AUTH_GOOGLE_CLIENT_ID }}
          AUTH_ALLOWED_EMAILS: ${{ secrets.AUTH_ALLOWED_EMAILS }}
          REPUTATION_STATE_BUCKET: ${{ secrets.REPUTATION_STATE_BUCKET }}
        run: |
          set -euo pipefail

          cp backend/reputation/cloudrun.env.example backend/reputation/cloudrun.env

          awk '$0 !~ /^(AUTH_GOOGLE_CLIENT_ID|AUTH_ALLOWED_EMAILS|GOOGLE_CLOUD_LOGIN_REQUESTED|REPUTATION_STATE_BUCKET|REPUTATION_STATE_PREFIX)=/' \
            backend/reputation/cloudrun.env > backend/reputation/cloudrun.env.tmp
          mv backend/reputation/cloudrun.env.tmp backend/reputation/cloudrun.env

          LOGIN_REQUESTED="${{ steps.login_toggle.outputs.value }}"
          STATE_BUCKET="$(echo "${REPUTATION_STATE_BUCKET:-}" | tr -d '\r\n')"
          STATE_PREFIX="reputation-state"

          if [ "${LOGIN_REQUESTED}" = "true" ] && [ -z "${AUTH_GOOGLE_CLIENT_ID:-}" ]; then
            echo "Missing AUTH_GOOGLE_CLIENT_ID secret."
            exit 1
          fi
          if [ "${LOGIN_REQUESTED}" = "true" ] && [ -z "${AUTH_ALLOWED_EMAILS:-}" ]; then
            echo "Missing AUTH_ALLOWED_EMAILS secret."
            exit 1
          fi
          if [ -z "${STATE_BUCKET}" ]; then
            echo "Missing REPUTATION_STATE_BUCKET secret (durable persistence required)."
            exit 1
          fi

          {
            echo "GOOGLE_CLOUD_LOGIN_REQUESTED=${LOGIN_REQUESTED}"
            if [ "${LOGIN_REQUESTED}" = "true" ]; then
              echo "AUTH_GOOGLE_CLIENT_ID=${AUTH_GOOGLE_CLIENT_ID}"
              echo "AUTH_ALLOWED_EMAILS=${AUTH_ALLOWED_EMAILS}"
            fi
            echo "REPUTATION_STATE_BUCKET=${STATE_BUCKET}"
            echo "REPUTATION_STATE_PREFIX=${STATE_PREFIX}"
          } >> backend/reputation/cloudrun.env

      - name: Bundle samples into backend source (must exist in container)
        run: |
          set -euo pipefail
          mkdir -p backend/data

          rsync -a --delete data/reputation_samples/ backend/data/reputation_samples/
          rsync -a --delete data/reputation_llm_samples/ backend/data/reputation_llm_samples/

          test -f backend/data/reputation_samples/README.md
          test -f backend/data/reputation_llm_samples/README.md

          echo "== backend/data after bundling =="
          ls -la backend/data
          ls -la backend/data/reputation_samples | head
          ls -la backend/data/reputation_llm_samples | head

      - name: Build backend image with Cloud Build (cloudbuild-backend.yaml)
        id: build
        run: |
          set -euo pipefail

          TS="$(date +%Y%m%d-%H%M%S)"
          IMAGE="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT}/${AR_REPO}/${AR_IMAGE_BACK_NAME}:${TS}"
          CB_BUCKET="${GCP_PROJECT}-cloudbuild"

          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
          echo "IMAGE=$IMAGE"
          echo "CB_BUCKET=$CB_BUCKET"

          gcloud builds submit . \
            --project="${GCP_PROJECT}" \
            --region="${GCP_REGION}" \
            --config=cloudbuild-backend.yaml \
            --substitutions=_IMAGE="${IMAGE}" \
            --gcs-source-staging-dir="gs://${CB_BUCKET}/source"

      - name: Deploy backend to Cloud Run (by image)
        run: |
          set -euo pipefail
          IMAGE="${{ steps.build.outputs.image }}"

          gcloud run deploy "$BACKEND_SERVICE" \
            --project "$GCP_PROJECT" \
            --region "$GCP_REGION" \
            --image "$IMAGE" \
            --service-account "$BACKEND_RUNTIME_SA" \
            --no-allow-unauthenticated \
            --port 8080 \
            --min-instances 0 \
            --max-instances "$BACKEND_MAX_INSTANCES" \
            --concurrency "$BACKEND_CONCURRENCY" \
            --cpu "$BACKEND_CPU" \
            --memory "$BACKEND_MEMORY" \
            --cpu-throttling \
            --timeout 300 \
            --env-vars-file backend/reputation/cloudrun.env

      - name: Route backend traffic to latest revision
        run: |
          set -euo pipefail
          gcloud run services update-traffic "$BACKEND_SERVICE" \
            --project "$GCP_PROJECT" \
            --region "$GCP_REGION" \
            --to-latest

      - name: Show backend URL
        id: backend_url
        run: |
          set -euo pipefail
          BACKEND_URL="$(gcloud run services describe "$BACKEND_SERVICE" \
            --project "$GCP_PROJECT" \
            --region "$GCP_REGION" \
            --format 'value(status.url)')"
          echo "url=$BACKEND_URL" >> "$GITHUB_OUTPUT"
          echo "$BACKEND_URL"