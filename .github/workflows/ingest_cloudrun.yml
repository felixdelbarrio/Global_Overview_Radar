name: ingest_cloudrun

on:
  schedule:
    # 03:00 UTC daily (ajusta segÃºn tu zona horaria)
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      force:
        description: "Forzar ingesta (true/false)"
        required: false
        default: "true"
      all_sources:
        description: "Ignorar toggles y probar todas las fuentes (true/false)"
        required: false
        default: "false"

concurrency:
  group: ingest-cloudrun
  cancel-in-progress: true

jobs:
  ingest:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      GCP_PROJECT: global-overview-radar
      GCP_REGION: europe-southwest1
      BACKEND_SERVICE: gor-backend
      AUTH_GOOGLE_CLIENT_ID: ${{ secrets.AUTH_GOOGLE_CLIENT_ID }}
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Trigger backend ingest
        env:
          FORCE: ${{ github.event.inputs.force || 'true' }}
          ALL_SOURCES: ${{ github.event.inputs.all_sources || 'false' }}
        run: |
          set -euo pipefail
          if [ -z "${AUTH_GOOGLE_CLIENT_ID:-}" ]; then
            echo "Missing AUTH_GOOGLE_CLIENT_ID secret."
            exit 1
          fi

          BACKEND_URL="$(gcloud run services describe "$BACKEND_SERVICE" --project "$GCP_PROJECT" --region "$GCP_REGION" --format 'value(status.url)')"
          if [ -z "$BACKEND_URL" ]; then
            echo "Failed to resolve backend URL."
            exit 1
          fi

          RUN_TOKEN="$(gcloud auth print-identity-token --audiences="$BACKEND_URL")"
          USER_TOKEN="$(gcloud auth print-identity-token --audiences="$AUTH_GOOGLE_CLIENT_ID" --include-email)"

          api_get() {
            curl -sS -f "$BACKEND_URL$1" \
              -H "Authorization: Bearer ${RUN_TOKEN}" \
              -H "x-user-id-token: ${USER_TOKEN}"
          }

          api_post() {
            local path="$1"
            local payload="$2"
            curl -sS -f -X POST "$BACKEND_URL$path" \
              -H "Authorization: Bearer ${RUN_TOKEN}" \
              -H "x-user-id-token: ${USER_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "$payload"
          }

          wait_job() {
            local job_id="$1"
            echo "Ingest job started: $job_id"
            for i in {1..60}; do
              job="$(api_get "/ingest/jobs/$job_id")"
              status="$(printf '%s' "$job" | jq -r '.status')"
              echo "Status: $status"
              if [ "$status" = "success" ]; then
                echo "$job" | jq .
                return 0
              fi
              if [ "$status" = "error" ]; then
                echo "$job" | jq .
                return 1
              fi
              sleep 10
            done
            echo "Timeout waiting for ingest job."
            return 1
          }

          set_profile() {
            local source="$1"
            local profiles_json="$2"
            payload="$(jq -n --arg source "$source" --argjson profiles "$profiles_json" '{source:$source, profiles:$profiles}')"
            api_post "/reputation/profiles" "$payload" >/dev/null
            echo "Profile set to $source: $profiles_json"
          }

          start_ingest() {
            payload="$(jq -n --argjson force "$FORCE" --argjson all "$ALL_SOURCES" '{force:$force, all_sources:$all}')"
            response="$(api_post "/ingest/reputation" "$payload")"
            job_id="$(printf '%s' "$response" | jq -r '.id')"
            if [ -z "$job_id" ] || [ "$job_id" = "null" ]; then
              echo "No job id returned: $response"
              return 1
            fi
            wait_job "$job_id"
          }

          current="$(api_get "/reputation/profiles")"
          orig_source="$(printf '%s' "$current" | jq -r '.active.source // "default"')"
          orig_profiles="$(printf '%s' "$current" | jq -c '.active.profiles // []')"
          echo "Original profile: ${orig_source} ${orig_profiles}"

          set_profile "samples" '["banking_bbva_retail"]'
          start_ingest

          set_profile "samples" '["banking_bbva_empresas"]'
          start_ingest

          set_profile "$orig_source" "$orig_profiles"
