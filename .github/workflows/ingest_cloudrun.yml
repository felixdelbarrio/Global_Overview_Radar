name: ingest_cloudrun

on:
  schedule:
    # 03:00 UTC daily (ajusta seg√∫n tu zona horaria)
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      force:
        description: "Forzar ingesta (true/false)"
        required: false
        default: "true"
      all_sources:
        description: "Ignorar toggles y probar todas las fuentes (true/false)"
        required: false
        default: "true"

concurrency:
  group: ingest-cloudrun
  cancel-in-progress: true

jobs:
  ingest:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      GCP_PROJECT: global-overview-radar
      GCP_REGION: europe-southwest1
      BACKEND_SERVICE: gor-backend
      AUTH_GOOGLE_CLIENT_ID: ${{ secrets.AUTH_GOOGLE_CLIENT_ID }}
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Trigger backend ingest
        env:
          FORCE: ${{ github.event.inputs.force || 'true' }}
          ALL_SOURCES: ${{ github.event.inputs.all_sources || 'true' }}
        run: |
          set -euo pipefail
          if [ -z "${AUTH_GOOGLE_CLIENT_ID:-}" ]; then
            echo "Missing AUTH_GOOGLE_CLIENT_ID secret."
            exit 1
          fi

          BACKEND_URL="$(gcloud run services describe "$BACKEND_SERVICE" --project "$GCP_PROJECT" --region "$GCP_REGION" --format 'value(status.url)')"
          if [ -z "$BACKEND_URL" ]; then
            echo "Failed to resolve backend URL."
            exit 1
          fi

          RUN_TOKEN="$(gcloud auth print-identity-token --audiences="$BACKEND_URL")"
          USER_TOKEN="$(gcloud auth print-identity-token --audiences="$AUTH_GOOGLE_CLIENT_ID" --include-email)"

          payload="$(jq -n --argjson force "$FORCE" --argjson all "$ALL_SOURCES" '{force:$force, all_sources:$all}')"
          response="$(curl -sS -f -X POST "$BACKEND_URL/ingest/reputation" \
            -H "Authorization: Bearer ${RUN_TOKEN}" \
            -H "x-user-id-token: ${USER_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$payload")"

          job_id="$(printf '%s' "$response" | jq -r '.id')"
          if [ -z "$job_id" ] || [ "$job_id" = "null" ]; then
            echo "No job id returned: $response"
            exit 1
          fi

          echo "Ingest job started: $job_id"
          for i in {1..60}; do
            job="$(curl -sS -f "$BACKEND_URL/ingest/jobs/$job_id" \
              -H "Authorization: Bearer ${RUN_TOKEN}" \
              -H "x-user-id-token: ${USER_TOKEN}")"
            status="$(printf '%s' "$job" | jq -r '.status')"
            echo "Status: $status"
            if [ "$status" = "success" ]; then
              echo "$job" | jq .
              exit 0
            fi
            if [ "$status" = "error" ]; then
              echo "$job" | jq .
              exit 1
            fi
            sleep 10
          done

          echo "Timeout waiting for ingest job."
          exit 1
