name: deploy_demo

on:
  workflow_run:
    workflows: ["CI - Backend", "CI - Frontend"]
    types: [completed]

concurrency:
  group: deploy-demo-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  gate:
    # Ejecuta solo cuando termina el CI de Frontend (reduce runs duplicados),
    # pero valida que backend+frontend han pasado.
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'master' &&
      github.event.workflow_run.name == 'CI - Frontend'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      pull-requests: read
    outputs:
      ok: ${{ steps.check.outputs.ok }}
      sha: ${{ steps.check.outputs.sha }}
    steps:
      - name: Check required workflows succeeded
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = ["backend.yml", "frontend.yml"];
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headSha = context.payload.workflow_run.head_sha;

            let allOk = true;

            for (const wf of workflows) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: wf,
                head_sha: headSha,
                per_page: 1,
              });
              const run = runs.data.workflow_runs[0];
              if (!run || run.status !== "completed" || run.conclusion !== "success") {
                allOk = false;
                core.info(
                  `Workflow ${wf} not successful for ${headSha}: ${
                    run ? `${run.status}/${run.conclusion}` : "missing"
                  }`
                );
              }
            }

            // Solo desplegar merges a master
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner,
              repo,
              commit_sha: headSha,
            });
            const mergedPr = prs.data.find(
              (pr) => pr.merged_at && pr.base && pr.base.ref === "master"
            );
            if (!mergedPr) {
              allOk = false;
              core.info(`No merged PR found for ${headSha}. Skipping deploy.`);
            }

            core.setOutput("ok", allOk ? "true" : "false");
            core.setOutput("sha", headSha);

  deploy:
    needs: gate
    if: needs.gate.outputs.ok == 'true'
    runs-on: ubuntu-latest

    environment:
      name: Preview
      url: https://global-overview-radar.vercel.app/

    permissions:
      contents: read
      deployments: write

    steps:
      - name: Create GitHub Deployment (demo)
        id: create_deploy
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = `${{ needs.gate.outputs.sha }}`;

            const res = await github.rest.repos.createDeployment({
              owner,
              repo,
              ref: sha,
              environment: "demo",
              auto_merge: false,
              required_contexts: [],
              description: "Demo deploy (Render/Vercel hooks)",
              transient_environment: true,
              production_environment: false,
            });

            core.setOutput("deployment_id", String(res.data.id));

      - name: Mark deployment as in_progress
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const deployment_id = Number(`${{ steps.create_deploy.outputs.deployment_id }}`);
            const demoUrl = "https://global-overview-radar.vercel.app/";

            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id,
              state: "in_progress",
              environment_url: demoUrl,
              description: "Deploy in progress",
            });

      - name: Trigger Render deploy hook
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          set -euo pipefail
          if [ -z "${RENDER_DEPLOY_HOOK_URL:-}" ]; then
            echo "Render hook not configured (missing RENDER_DEPLOY_HOOK_URL secret)."
            exit 0
          fi
          url="${RENDER_DEPLOY_HOOK_URL}"
          code="$(curl -sS -o /tmp/render_hook.out -w "%{http_code}" -X POST -L "$url" || true)"
          if [ "${code}" = "405" ]; then
            code="$(curl -sS -o /tmp/render_hook.out -w "%{http_code}" -L "$url")"
          fi
          echo "Render deploy hook HTTP ${code}"
          cat /tmp/render_hook.out || true
          test "${code}" -ge 200 -a "${code}" -lt 400

      - name: Trigger Vercel deploy hook
        env:
          VERCEL_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
        run: |
          set -euo pipefail
          if [ -z "${VERCEL_DEPLOY_HOOK_URL:-}" ]; then
            echo "Vercel hook not configured (missing VERCEL_DEPLOY_HOOK_URL secret)."
            exit 0
          fi
          url="${VERCEL_DEPLOY_HOOK_URL}"
          code="$(curl -sS -o /tmp/vercel_hook.out -w "%{http_code}" -X POST -L "$url" || true)"
          if [ "${code}" = "405" ]; then
            code="$(curl -sS -o /tmp/vercel_hook.out -w "%{http_code}" -L "$url")"
          fi
          echo "Vercel deploy hook HTTP ${code}"
          cat /tmp/vercel_hook.out || true
          test "${code}" -ge 200 -a "${code}" -lt 400

      - name: Demo health check (wait for Vercel)
        env:
          DEMO_URL: https://global-overview-radar.vercel.app/
        run: |
          set -euo pipefail
          echo "Waiting for demo to become healthy: ${DEMO_URL}"

          # Up to ~3 minutes: 18 tries * 10s
          for i in $(seq 1 18); do
            code="$(curl -s -o /dev/null -w "%{http_code}" "${DEMO_URL}" || true)"
            echo "Attempt ${i}/18 -> HTTP ${code}"
            if [ "${code}" = "200" ] || [ "${code}" = "301" ] || [ "${code}" = "302" ]; then
              echo "Demo is reachable (HTTP ${code})."
              exit 0
            fi
            sleep 10
          done

          echo "Demo health check failed (no 200/301/302 after waiting)."
          exit 1

      - name: Mark deployment as success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const deployment_id = Number(`${{ steps.create_deploy.outputs.deployment_id }}`);
            const demoUrl = "https://global-overview-radar.vercel.app/";

            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id,
              state: "success",
              environment_url: demoUrl,
              description: "Deploy succeeded (health check passed)",
            });

      - name: Mark deployment as failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const deployment_id = Number(`${{ steps.create_deploy.outputs.deployment_id }}`);
            const demoUrl = "https://global-overview-radar.vercel.app/";

            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id,
              state: "failure",
              environment_url: demoUrl,
              description: "Deploy failed (hooks or health check)",
            });